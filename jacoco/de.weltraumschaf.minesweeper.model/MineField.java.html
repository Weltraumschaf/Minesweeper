<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>MineField.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Minesweeper</a> &gt; <a href="index.html" class="el_package">de.weltraumschaf.minesweeper.model</a> &gt; <span class="el_source">MineField.java</span></div><h1>MineField.java</h1><pre class="source lang-java linenums">/*
 *  LICENSE
 *
 * &quot;THE BEER-WARE LICENSE&quot; (Revision 43):
 * &quot;Sven Strittmatter&quot; &lt;weltraumschaf@googlemail.com&gt; wrote this file.
 * As long as you retain this notice you can do whatever you want with
 * this stuff. If we meet some day, and you think this stuff is worth it,
 * you can buy me a non alcohol-free beer in return.
 *
 * Copyright (C) 2012 &quot;Sven Strittmatter&quot; &lt;weltraumschaf@googlemail.com&gt;
 */
package de.weltraumschaf.minesweeper.model;

import de.weltraumschaf.minesweeper.Matrix;
import java.util.ArrayList;
import java.util.List;
import java.util.Locale;
import java.util.Random;
import org.apache.commons.lang3.Validate;
import org.apache.log4j.Logger;

/**
 * Represents a mine field which contains mine and save boxes randomly.
 *
 * @author Sven Strittmatter &lt;weltraumschaf@googlemail.com&gt;
 */
public class MineField {

    /**
     * Default Width.
     */
    public static final int DEFAULT_WIDTH = 8;
    /**
     * Default height.
     */
    public static final int DEFAULT_HEIGHT = 8;
    /**
     * Log facility.
     */
<span class="fc" id="L40">    private static final Logger LOG = Logger.getLogger(MineField.class);</span>
    /**
     * 1/8 mines.
     */
    private static final int MINE_FACTOR = 8;
    /**
     * Used to calculate percentage of mines and save boxes.
     */
    private static final double HUNDRED_PERCENT = 100.0;
    /**
     * How many boxes in the height.
     */
    private final int height;
    /**
     * How many boxes in the width.
     */
    private final int width;
    /**
     * The box matrix.
     */
    private final Matrix&lt;FieldBox&gt; boxes;
    /**
     * Used to initialize the box matrix randomly.
     */
<span class="fc" id="L64">    private final Random random = new Random();</span>
    /**
     * Whether a mine was opened and game is over.
     */
    private boolean gameOver;
    /**
     * Whether {@link #initializeFieldWithBoxes()} was invoked at least once.
     */
    private boolean initialized;

    /**
     * Initializes width and height with {@link #DEFAULT_WIDTH} and {@link #DEFAULT_HEIGHT}.
     */
    public MineField() {
<span class="fc" id="L78">        this(DEFAULT_HEIGHT, DEFAULT_WIDTH);</span>
<span class="fc" id="L79">    }</span>

    /**
     * Dedicated constructor.
     *
     * @param height must not be less than 1
     * @param width must not be less than 1
     */
    public MineField(final int height, final int width) {
<span class="fc" id="L88">        super();</span>
<span class="fc bfc" id="L89" title="All 2 branches covered.">        Validate.isTrue(height &gt; 0, &quot;Height must not be less than 1!&quot;);</span>
<span class="fc" id="L90">        this.height = height;</span>
<span class="fc bfc" id="L91" title="All 2 branches covered.">        Validate.isTrue(width &gt; 0, &quot;Width must not be less than 1!&quot;);</span>
<span class="fc" id="L92">        this.width = width;</span>
<span class="fc" id="L93">        this.boxes = new Matrix&lt;FieldBox&gt;(FieldBox.class, width, height);</span>
<span class="fc" id="L94">    }</span>

    /**
     * Set all fields in {@link #boxes} with an instance.
     */
    public void initializeFieldWithBoxes() {
<span class="fc bfc" id="L100" title="All 2 branches covered.">        for (int rowId = 0; rowId &lt; height; ++rowId) {</span>
<span class="fc bfc" id="L101" title="All 2 branches covered.">            for (int columnId = 0; columnId &lt; width; ++columnId) {</span>
<span class="fc" id="L102">                boxes.set(columnId, rowId, createRandomBox(columnId, rowId));</span>
            }
        }

<span class="fc" id="L106">        setInitialized(true);</span>
<span class="fc" id="L107">    }</span>

    /**
     * Set the state to initialized.
     *
     * @param initialized {@code true} if boxes are initialized, else {@code false}
     */
    void setInitialized(final boolean initialized) {
<span class="fc" id="L115">        this.initialized = initialized;</span>
<span class="fc" id="L116">    }</span>

    @Override
    public String toString() {
<span class="fc" id="L120">        final StringBuilder buffer = new StringBuilder();</span>
<span class="fc" id="L121">        buffer.append(String.format(&quot;Mine field (width: %s, height: %s)%n&quot;, getWidth(), getHeight()))</span>
                .append(boxes.toString());

<span class="fc" id="L124">        int minesCount = 0;</span>
<span class="fc" id="L125">        int savesCount = 0;</span>

<span class="fc bfc" id="L127" title="All 2 branches covered.">        for (final FieldBox box : boxes.getAll()) {</span>
<span class="fc bfc" id="L128" title="All 2 branches covered.">            if (box.isMine()) {</span>
<span class="fc" id="L129">                ++minesCount;</span>
            } else {
<span class="fc" id="L131">                ++savesCount;</span>
            }
<span class="fc" id="L133">        }</span>

<span class="fc" id="L135">        final double count = minesCount + savesCount;</span>
<span class="fc" id="L136">        final double minesPercent = (HUNDRED_PERCENT / count) * minesCount;</span>
<span class="fc" id="L137">        final double savesPercent = (HUNDRED_PERCENT / count) * savesCount;</span>
<span class="fc" id="L138">        buffer.append(String.format(Locale.ENGLISH, &quot;Mines: %s (%.2f %%), saves: %s (%.2f %%)&quot;,</span>
                minesCount, minesPercent, savesCount, savesPercent));
<span class="fc" id="L140">        return buffer.toString();</span>
    }

    /**
     * Create randomly a mine or save box.
     *
     * In average a quarter of created boxes is a mine.
     *
     * @param rowId must not be less than 0
     * @param columnId must not be less than 0
     * @return always new instance
     */
    private BaseMineFieldBox createRandomBox(final int rowId, final int columnId) {
<span class="fc bfc" id="L153" title="All 2 branches covered.">        if (random.nextInt() % MINE_FACTOR == 0) {</span>
<span class="fc" id="L154">            return new MineBox(rowId, columnId, this);</span>
        } else {
<span class="fc" id="L156">            return new SaveBox(rowId, columnId, this);</span>
        }
    }

    /**
     * Get the neighbors of a box.
     *
     * &lt;pre&gt;
     * +-----+-------+-----+
     * | 3,3 |  4,3  | 5,3 |
     * +-----+-------+-----+
     * | 3,4 | [4,4] | 5,4 |
     * +-----+-------+-----+
     * | 3,5 |  4,5  | 5,5 |
     * +-----+-------+-----+
     * &lt;/pre&gt;
     *
     * Throws {@link IllegalStateException} if {@link #initializeFieldWithBoxes()} never called before.
     *
     * @param rowId must not be less than 0
     * @param columnId must not be less than 0
     * @return never {@code null}, maybe empty list
     */
    List&lt;FieldBox&gt; getNeighboursOfBox(final int rowId, final int columnId) {
<span class="fc bfc" id="L180" title="All 2 branches covered.">        if (!initialized) {</span>
<span class="fc" id="L181">            throw new IllegalStateException(</span>
                    &quot;Field not initialized! Invoke MineField#initializeFieldWithBoxes() first.&quot;);
        }

<span class="fc bfc" id="L185" title="All 2 branches covered.">        Validate.isTrue(rowId &gt;= 0, &quot;Row id must not be less than 0!&quot;);</span>
<span class="fc bfc" id="L186" title="All 2 branches covered.">        Validate.isTrue(columnId &gt;= 0, &quot;Column id must not be less than 0!&quot;);</span>
<span class="fc" id="L187">        int rowIdStart = rowId - 1;</span>

<span class="fc bfc" id="L189" title="All 2 branches covered.">        if (rowIdStart &lt; 0) {</span>
<span class="fc" id="L190">            rowIdStart = 0;</span>
        }

<span class="fc" id="L193">        int columnIdStart = columnId - 1;</span>

<span class="fc bfc" id="L195" title="All 2 branches covered.">        if (columnIdStart &lt; 0) {</span>
<span class="fc" id="L196">            columnIdStart = 0;</span>
        }

<span class="fc" id="L199">        int rowIdStop = rowId + 1;</span>

<span class="fc bfc" id="L201" title="All 2 branches covered.">        if (rowIdStop &gt; width - 1) {</span>
<span class="fc" id="L202">            rowIdStop = width - 1;</span>
        }

<span class="fc" id="L205">        int columnIdStop = columnId + 1;</span>

<span class="fc bfc" id="L207" title="All 2 branches covered.">        if (columnIdStop &gt; height - 1) {</span>
<span class="fc" id="L208">            columnIdStop = height - 1;</span>
        }

<span class="fc" id="L211">        final List&lt;FieldBox&gt; neighbours = new ArrayList&lt;FieldBox&gt;();</span>

<span class="fc bfc" id="L213" title="All 2 branches covered.">        for (int x = rowIdStart; x &lt;= rowIdStop; ++x) {</span>
<span class="fc bfc" id="L214" title="All 2 branches covered.">            for (int y = columnIdStart; y &lt;= columnIdStop; ++y) {</span>
<span class="fc bfc" id="L215" title="All 4 branches covered.">                if (x == rowId &amp;&amp; y == columnId) {</span>
<span class="fc" id="L216">                    continue; // Ignore self.</span>
                }

<span class="fc" id="L219">                neighbours.add(boxes.get(x, y));</span>
            }
        }

<span class="fc" id="L223">        return neighbours;</span>
    }

    /**
     * Get width.
     *
     * @return never less than 1
     */
    public int getWidth() {
<span class="fc" id="L232">        return width;</span>
    }

    /**
     * Get height.
     *
     * @return never less than 1
     */
    public int getHeight() {
<span class="fc" id="L241">        return height;</span>
    }

    /**
     * Get the field box a given position.
     *
     * Throws {@link IllegalStateException} if {@link #initializeFieldWithBoxes()} never called before.
     *
     * @param x must not be less than 0 and greater than {@link #getWidth()} - 1.
     * @param y must not be less than 0 and greater than {@link #getHeight()} - 1.
     * @return never {@code null}
     */
    public FieldBox getBox(final int x, final int y) {
<span class="fc bfc" id="L254" title="All 2 branches covered.">        if (!initialized) {</span>
<span class="fc" id="L255">            throw new IllegalStateException(</span>
                    &quot;Field not initialized! Invoke MineField#initializeFieldWithBoxes() first.&quot;);
        }

<span class="fc" id="L259">        return boxes.get(x, y);</span>
    }

    /**
     * Set the field box a given position.
     *
     * @param x must not be less than 0 and greater than {@link #getWidth()} - 1.
     * @param y must not be less than 0 and greater than {@link #getHeight()} - 1.
     * @param box must not be {@code null}
     */
    void setBox(final int x, final int y, final FieldBox box) {
<span class="fc" id="L270">        boxes.set(x, y, box);</span>
<span class="fc" id="L271">    }</span>

    /**
     * Set the game as lost if a mine was opened.
     */
    public void setGameOver() {
<span class="fc" id="L277">        gameOver = true;</span>

<span class="fc bfc" id="L279" title="All 2 branches covered.">        for (final FieldBox b : getBoxes().getAll()) {</span>
<span class="fc" id="L280">            b.setOpened(true);</span>
<span class="fc" id="L281">        }</span>
<span class="fc" id="L282">    }</span>

    /**
     * Whether the game was lost.
     *
     * @return {@code true} if a mine was opened, else {@code false}
     */
    public boolean isGameOver() {
<span class="fc" id="L290">        return gameOver;</span>
    }

    /**
     * Whether the game was won.
     *
     * @return {@code true} if all fields are opened or flagged and no mine was opened, else {@code false}
     */
    public boolean hasWon() {
<span class="fc" id="L299">        LOG.debug(&quot;Determine if won...&quot;);</span>

<span class="fc bfc" id="L301" title="All 2 branches covered.">        if (isGameOver()) {</span>
<span class="fc" id="L302">            LOG.debug(&quot;Game is over, not won!&quot;);</span>
<span class="fc" id="L303">            return false;</span>
        } else {
<span class="fc" id="L305">            LOG.debug(&quot;Game is not over.&quot;);</span>
        }

<span class="fc bfc" id="L308" title="All 2 branches covered.">        if (allBoxesOpenOrFlagged()) {</span>
<span class="fc" id="L309">            LOG.debug(&quot;All boxes opened or flagged.&quot;);</span>
<span class="fc" id="L310">            return true;</span>
        } else {
<span class="fc" id="L312">            LOG.debug(&quot;Not all boxes opened or flagged!&quot;);</span>
<span class="fc" id="L313">            return false;</span>
        }
    }

    /**
     * Get the boxes.
     *
     * @return never {@code null}
     */
    public Matrix&lt;FieldBox&gt; getBoxes() {
<span class="fc" id="L323">        return boxes;</span>
    }

    /**
     * Determines if all {@link FieldBox boxes} of the field are opened or flagged.
     *
     * @return {@code true} if all boxes are opened/flagged, else {@code false}
     */
    boolean allBoxesOpenOrFlagged() {
<span class="fc" id="L332">        return allBoxesOpenOrFlagged(boxes.getAll());</span>
    }

    /**
     * Determines if all {@link FieldBox boxes} are opened or flagged.
     *
     * @param list must not be {@code null}
     * @return {@code true} if all boxes are opened/flagged, else {@code false}
     */
    static boolean allBoxesOpenOrFlagged(final List&lt;FieldBox&gt; list) {
<span class="fc" id="L342">        Validate.notNull(list, &quot;List must not be null!&quot;);</span>

<span class="fc bfc" id="L344" title="All 2 branches covered.">        for (final FieldBox box : list) {</span>
<span class="fc bfc" id="L345" title="All 4 branches covered.">            if (!box.isOpen() &amp;&amp; !box.isFlag()) {</span>
<span class="fc" id="L346">                return false;</span>
            }
<span class="fc" id="L348">        }</span>

<span class="fc" id="L350">        return true;</span>
    }

    /**
     * Returns number of unflagged mines.
     *
     * @return not negative number
     */
    public int countUnflaggedMines() {
<span class="fc" id="L359">        int count = 0;</span>

<span class="fc bfc" id="L361" title="All 2 branches covered.">        for (final FieldBox box : boxes.getAll()) {</span>
<span class="fc bfc" id="L362" title="All 4 branches covered.">            if (box.isMine() &amp;&amp; !box.isFlag()) {</span>
<span class="fc" id="L363">                ++count;</span>
            }
<span class="fc" id="L365">        }</span>

<span class="fc" id="L367">        return count;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.3.201306030806</span></div></body></html>