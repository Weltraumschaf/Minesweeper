<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>FieldBoxButton.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Minesweeper</a> &gt; <a href="index.html" class="el_package">de.weltraumschaf.minesweeper.gui</a> &gt; <span class="el_source">FieldBoxButton.java</span></div><h1>FieldBoxButton.java</h1><pre class="source lang-java linenums">/*
 *  LICENSE
 *
 * &quot;THE BEER-WARE LICENSE&quot; (Revision 43):
 * &quot;Sven Strittmatter&quot; &lt;weltraumschaf@googlemail.com&gt; wrote this file.
 * As long as you retain this notice you can do whatever you want with
 * this stuff. If we meet some day, and you think this stuff is worth it,
 * you can buy me a non alcohol-free beer in return.
 *
 * Copyright (C) 2012 &quot;Sven Strittmatter&quot; &lt;weltraumschaf@googlemail.com&gt;
 */
package de.weltraumschaf.minesweeper.gui;

import de.weltraumschaf.minesweeper.model.FieldBox;
import de.weltraumschaf.minesweeper.model.Game;
import java.util.Observable;
import java.util.Observer;
import javax.swing.Icon;
import javax.swing.JLabel;
import org.apache.commons.lang3.Validate;
import org.apache.log4j.Logger;

/**
 * Represents a mine filed box button.
 *
 * A button has three states: Closed, open, flagged.
 *
 * @author Sven Strittmatter &lt;weltraumschaf@googlemail.com&gt;
 */
public class FieldBoxButton extends JLabel implements Observer {

    /**
     * Log facility.
     */
<span class="fc" id="L35">    private static final Logger LOG = Logger.getLogger(FieldBoxButton.class);</span>
    /**
     * Zero mines in neighborhood.
     */
    private static final int ZERO_NEIGHBORS = 0;
    /**
     * One mines in neighborhood.
     */
    private static final int ONE_NEIGHBORS = 1;
    /**
     * Two mines in neighborhood.
     */
    private static final int TWO_NEIGHBORS = 2;
    /**
     * Three mines in neighborhood.
     */
    private static final int THREE_NEIGHBORS = 3;
    /**
     * Four mines in neighborhood.
     */
    private static final int FOUR_NEIGHBORS = 4;
    /**
     * Five mines in neighborhood.
     */
    private static final int FIVE_NEIGHBORS = 5;
    /**
     * Six mines in neighborhood.
     */
    private static final int SIX_NEIGHBORS = 6;
    /**
     * Seven mines in neighborhood.
     */
    private static final int SEVEN_NEIGHBORS = 7;
    /**
     * Eight mines in neighborhood.
     */
    private static final int EIGHT_NEIGHBORS = 8;
    /**
     * Shared exception message.
     */
    private static final String BOX_MODEL_NULL_EMESSAGE = &quot;Box model is null! Set box first.&quot;;
    /**
     * The data model behind the button.
     */
    private FieldBox box;

    /**
     * State of the button.
     *
     * The button holds an own state additional to {@link #box} to prevent endless loops by observer notification.
     */
<span class="fc" id="L86">    private State state = State.CLOSED;</span>

    /**
     * Dedicated constructor.
     *
     * Initializes the button with closed icon.
     */
    public FieldBoxButton() {
<span class="fc" id="L94">        super(ImageIcons.CLOSED.getResource());</span>
<span class="fc" id="L95">    }</span>

    /**
     * Determine if button is in state.
     *
     * @param s state to check.
     * @return {@code true} if button has passed in state, else {@code false}
     */
    boolean isInState(final State s) {
<span class="fc bfc" id="L104" title="All 2 branches covered.">        return state == s;</span>
    }

    /**
     * Set the state of the button.
     *
     * @param s must not be {@code null}
     */
    void setState(final State s) {
<span class="fc" id="L113">        Validate.notNull(s, &quot;State must not be null!&quot;);</span>
<span class="fc" id="L114">        this.state = s;</span>
<span class="fc" id="L115">    }</span>

    /**
     * Get the box model.
     *
     * @return never {@code null}
     */
    public FieldBox getBox() {
<span class="fc" id="L123">        return box;</span>
    }

    /**
     * Set the box model.
     *
     * Must be set before any operation can be performed on the button.
     *
     * @param box must not be {@code null}
     */
    public void setBox(final FieldBox box) {
<span class="fc" id="L134">        Validate.notNull(box, &quot;Box must not be null!&quot;);</span>
<span class="fc" id="L135">        this.box = box;</span>

<span class="pc bpc" id="L137" title="1 of 2 branches missed.">        if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L138">            setToolTipText(box.toString());</span>
        }
<span class="fc" id="L140">    }</span>

    /**
     * Open the box.
     */
    public void open() {
<span class="fc" id="L146">        Validate.notNull(box, BOX_MODEL_NULL_EMESSAGE);</span>

<span class="pc bpc" id="L148" title="1 of 2 branches missed.">        if (isOpen()) {</span>
<span class="nc" id="L149">            return;</span>
        }

<span class="fc" id="L152">        state = State.OPEN;</span>

<span class="fc bfc" id="L154" title="All 2 branches covered.">        if (box.isMine()) {</span>
<span class="fc" id="L155">            final Game game = box.getField().getGame();</span>

<span class="fc bfc" id="L157" title="All 2 branches covered.">            if (game.isGameOver()) {</span>
<span class="fc bfc" id="L158" title="All 2 branches covered.">                if (box.isFlag()) {</span>
<span class="fc" id="L159">                    setIcon(ImageIcons.BOMB.getResource());</span>
                } else {
<span class="fc" id="L161">                    setIcon(ImageIcons.BOMB_EXPLODED.getResource());</span>
                }
            } else {
<span class="fc" id="L164">                setIcon(ImageIcons.BOMB_EXPLODED.getResource());</span>
<span class="fc" id="L165">                game.setGameOver();</span>
<span class="fc" id="L166">                game.stop();</span>
            }
<span class="fc" id="L168">        } else {</span>
<span class="fc" id="L169">            setIcon(determineIcon());</span>
<span class="fc" id="L170">            box.setOpened(true);</span>

<span class="fc bfc" id="L172" title="All 2 branches covered.">            if (box.countMinesInNeighborhood() == 0) {</span>
<span class="fc" id="L173">                LOG.debug(&quot;Opened button has 0 mines in neighborhood.&quot;);</span>

<span class="fc bfc" id="L175" title="All 2 branches covered.">                for (final FieldBox neighbor : box.getNeighbours()) {</span>
<span class="fc" id="L176">                    LOG.debug(String.format(&quot;Open neighbor box %s.&quot;, neighbor));</span>
<span class="fc" id="L177">                    neighbor.setOpened(true);</span>
<span class="fc" id="L178">                }</span>
            }
        }

<span class="fc" id="L182">        repaint();</span>
<span class="fc" id="L183">    }</span>

    /**
     * Whether the box is open or not.
     *
     * @return {@code true} if button is open, else {@code false}
     */
    public boolean isOpen() {
<span class="fc" id="L191">        return isInState(State.OPEN);</span>
    }

    /**
     * Close the box.
     *
     * Already opened box can not be closed.
     */
    public void close() {
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">        if (isInState(State.CLOSED)) {</span>
<span class="nc" id="L201">            return;</span>
        }

<span class="fc" id="L204">        Validate.notNull(box, BOX_MODEL_NULL_EMESSAGE);</span>
<span class="fc" id="L205">        state = State.CLOSED;</span>
<span class="fc" id="L206">        box.setFlag(false);</span>
<span class="fc" id="L207">        box.setOpened(false);</span>
<span class="fc" id="L208">        setIcon(ImageIcons.CLOSED.getResource());</span>
<span class="fc" id="L209">        repaint();</span>
<span class="fc" id="L210">    }</span>

    /**
     * Flags a button to signal that there may be a mine.
     *
     * Only closed or not flagged buttons can be flagged.
     */
    public void flag() {
<span class="pc bpc" id="L218" title="1 of 2 branches missed.">        if (isInState(State.FLAG)) {</span>
<span class="nc" id="L219">            return;</span>
        }

<span class="fc" id="L222">        Validate.notNull(box, BOX_MODEL_NULL_EMESSAGE);</span>
<span class="fc" id="L223">        box.setFlag(true);</span>
<span class="fc" id="L224">        setIcon(ImageIcons.FLAG.getResource());</span>
<span class="fc" id="L225">        state = State.FLAG;</span>
<span class="fc" id="L226">        repaint();</span>
<span class="fc" id="L227">    }</span>

    /**
     * Whether the button is flagged.
     *
     * @return {@code true} if the button is in flagged state, else {@code false}
     */
    public boolean isFlag() {
<span class="nc" id="L235">        return isInState(State.FLAG);</span>
    }

    /**
     * Determines the right icon image (either bomb or number for mines in neighberhood).
     *
     * @return never {@code null}
     */
    Icon determineIcon() {
<span class="fc" id="L244">        Validate.notNull(box, BOX_MODEL_NULL_EMESSAGE);</span>
        final Icon icon;

<span class="fc bfc" id="L247" title="All 2 branches covered.">        if (box.isMine()) {</span>
<span class="fc" id="L248">            icon = ImageIcons.BOMB.getResource();</span>
        } else {
<span class="fc" id="L250">            icon = determineNumberIcon();</span>
        }

<span class="fc" id="L253">        return icon;</span>
    }

    /**
     * Determines the number icons for mines in neighborhood.
     *
     * @return never {@code null}
     */
    Icon determineNumberIcon() {
        final Icon icon;

<span class="fc bfc" id="L264" title="All 10 branches covered.">        switch (box.countMinesInNeighborhood()) {</span>
            case ZERO_NEIGHBORS:
<span class="fc" id="L266">                icon = ImageIcons.BLANK.getResource();</span>
<span class="fc" id="L267">                break;</span>
            case ONE_NEIGHBORS:
<span class="fc" id="L269">                icon = ImageIcons.ONE_NEIGHBOR.getResource();</span>
<span class="fc" id="L270">                break;</span>
            case TWO_NEIGHBORS:
<span class="fc" id="L272">                icon = ImageIcons.TWO_NEIGHBOR.getResource();</span>
<span class="fc" id="L273">                break;</span>
            case THREE_NEIGHBORS:
<span class="fc" id="L275">                icon = ImageIcons.THREE_NEIGHBOR.getResource();</span>
<span class="fc" id="L276">                break;</span>
            case FOUR_NEIGHBORS:
<span class="fc" id="L278">                icon = ImageIcons.FOUR_NEIGHBOR.getResource();</span>
<span class="fc" id="L279">                break;</span>
            case FIVE_NEIGHBORS:
<span class="fc" id="L281">                icon = ImageIcons.FIVE_NEIGHBOR.getResource();</span>
<span class="fc" id="L282">                break;</span>
            case SIX_NEIGHBORS:
<span class="fc" id="L284">                icon = ImageIcons.SIX_NEIGHBOR.getResource();</span>
<span class="fc" id="L285">                break;</span>
            case SEVEN_NEIGHBORS:
<span class="fc" id="L287">                icon = ImageIcons.SEVEN_NEIGHBOR.getResource();</span>
<span class="fc" id="L288">                break;</span>
            case EIGHT_NEIGHBORS:
<span class="fc" id="L290">                icon = ImageIcons.EIGHT_NEIGHBOR.getResource();</span>
<span class="fc" id="L291">                break;</span>
            default:
<span class="fc" id="L293">                throw new IllegalStateException(String.format(&quot;Unsupported neighbor count: %d!&quot;,</span>
                        box.countMinesInNeighborhood()));
        }

<span class="fc" id="L297">        return icon;</span>
    }

    @Override
    public void update(final Observable observable, final Object arg) {
<span class="nc" id="L302">        Validate.notNull(box, BOX_MODEL_NULL_EMESSAGE);</span>
<span class="nc" id="L303">        LOG.debug(String.format(&quot;Update button (state = %s) from observable (Box model: %s)&quot;, state, observable));</span>

<span class="nc bnc" id="L305" title="All 4 branches missed.">        if (box.isOpen() &amp;&amp; !box.isFlag()) {</span>
<span class="nc" id="L306">            LOG.debug(String.format(&quot;Open box %s.&quot;, box));</span>
<span class="nc" id="L307">            open();</span>
        }
<span class="nc" id="L309">    }</span>

    /**
     * Resets the button.
     *
     * &lt;ul&gt;
     * &lt;li&gt;set state to closed&lt;/li&gt;
     * &lt;li&gt;set icon to closed&lt;/li&gt;
     * &lt;li&gt;repaint button&lt;/li&gt;
     * &lt;/ul&gt;
     */
    void reset() {
<span class="nc" id="L321">        state = State.CLOSED;</span>
<span class="nc" id="L322">        setIcon(ImageIcons.CLOSED.getResource());</span>
<span class="nc" id="L323">        repaint();</span>
<span class="nc" id="L324">    }</span>

    @Override
    public String toString() {
<span class="nc" id="L328">        return &quot;FieldBoxButton{box=&quot; + box + &quot;, state=&quot; + state + '}';</span>
    }

    /**
     * Represent the button state.
     */
<span class="pc" id="L334">    static enum State {</span>

        /**
         * Button is closed.
         */
<span class="fc" id="L339">        CLOSED,</span>
        /**
         * Button has flag.
         */
<span class="fc" id="L343">        FLAG,</span>
        /**
         * Button is open.
         */
<span class="fc" id="L347">        OPEN;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.3.201306030806</span></div></body></html>